{{ $dot := .}}
{{ range $index, $_ := until (.Values.numStudents | int) -}}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: bm-lab-{{ add $index 1 }}
  namespace: openshift-gitops
  labels:
    {{- include "bootstrap.labels" $dot | nindent 4 }}
  annotations:
    argocd.argoproj.io/compare-options: IgnoreExtraneous
  finalizers:
    - resources-finalizer.argocd.argoproj.io          
spec:
  project: default
  source:
    repoURL: https://github.com/raffaelespazzoli/openshift-baremetal-lab.git
    targetRevision: HEAD
    path: charts/bmh-vm
    helm:
      values: |
        clusterName: cluster-{{ add $index 1 }}
        baseDomain: bm-lab.local
        networkConfiguration: {{ $.Values.environmentNetworking }}
        disconnectedEnvironment: {{ eq $.Values.environmentConnectivity "disconnected" }}
        proxiedEnvironment: {{ eq $.Values.environmentConnectivity "proxied" }}
        password: changeme
        storageClassName: {{ $.Values.storageClassName }}
        hostingClusterBaseDomain: {{ $.Values.clusterBaseDomain }}
  destination:
    server: https://kubernetes.default.svc
    namespace: bm-lab-{{ add $index 1 }}
  syncPolicy:
    syncOptions:
      - ApplyOutOfSyncOnly=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
      - ServerSideApply=true
      - FailOnSharedResource=true
      - RespectIgnoreDifferences=true
      - CreateNamespace=true
  ignoreDifferences:
  - group: kubevirt.io
    kind: VirtualMachine
    jsonPointers:      
      - /spec/running
    jqPathExpressions:    
      - .spec.template.spec.domain.devices.interfaces[].macAddress       
{{- end }}